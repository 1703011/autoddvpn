= Introduction =

這份文件說明如何更進階地在DDWRT裡面啟動OpenVPN，已獲得更多的功能支持。

= Details =

  * 手動啟動OpenVPN的目的
  * 設置方式


=   手動啟動OpenVPN的好處？ =
 # 如果你的openvpn server在啟動的時候需要指定user/pass, 也就是 auth-user-pass這樣的參數
 # 如果需要openvpn client可以ping server，必要的時候進行自動重啟
 # 你有多個openvpn server，需要進行remote-random的隨機連線配置

= 設置方式 =

在/jffs/openvpn/下編輯一個 openvpn.conf ，內容范例如下

{{{
up 'iptables -A POSTROUTING -t nat -o tun0 -j MASQUERADE; /jffs/openvpn/vpnup.sh openvpn'
down 'iptables -D POSTROUTING -t nat -o tun0 -j MASQUERADE; /jffs/openvpn/vpndown.sh openvpn'

client                 
dev tun                      
                            
ca /jffs/openvpn/ca.crt
cert /jffs/openvpn/client.crt
key /jffs/openvpn/client.key
             
<connection>
remote <server1_ip_address> 443 udp
</connection>             
             
<connection>
remote <server2_ip_address> 53 tcp
</connection>
                     
remote-random
     
resolv-retry infinite
nobind     
float      

persist-key
persist-tun
                      
comp-lzo      
verb 3 
remote-cert-tls server
shaper 5242880  

ping 10
ping-restart 60       
auth-user-pass /jffs/openvpn/password.txt  
}}}

注意:
 
 * 如果你只有一個openvpn server可以用，則只需要寫一個<connection>即可，同時不需要 remote-random
 * 如果你的openvpn server不需要user authentication, 則auth-user-pass不用寫
 * 如果openvpn server沒有啟動lzo壓縮傳輸，則comp-lzo不用寫

修改rc_startup
{{{
nvram set rc_startup='openvpn --config /jffs/openvpn/openvpn.conf --daemon'
}}}
開機時不啟動ddwrt自帶的openvpn client, 而是由rc_startup來啟動。
{{{
nvram set openvpncl_enable=0
nvram commit
}}}

然後重開機之後就可以了。

最後感謝 @jkgtw @yegle 的測試以及回報。